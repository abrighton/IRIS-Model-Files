subsystem = IRIS
component = imager-detector-assembly

description = """
Imager Detector Assembly Commands.

This command model is designed based on [Software Design Patterns for Device and Component Controllers (TMT.INS.TEC.16.079.DRF01)](https://docushare.tmt.org/docushare/dsweb/Get/Document-57492/cc_design_patterns_DRF01_b.docx). As proposed by the design pattern, standard assembly commands and assembly-specific commands are provided for each functional group. All commands are classified into either 'request' or 'submit' based on the command type defintion described in the design pattern document.
"""

receive = [
    {
        name = INIT
        description = """
This command reloads system configuration (e.g. gain, number of read channels) of the detectors and the detector controllers. This command can be invoked only when there is no on-going exposure.

Command type: request
"""
    }
    {
        name = TEST
        description = """This command executes a self-test.

__TBD__: Actual action to be taken is TBD.

Command type: request
"""
    }
    {
        name = START_EXPOSURE
        description = """
This command starts a new exposure with the given cofinguration.

Command type: submit
"""
        requiredArgs = [obsId, rampIntegrationTime, subregion]
        args = [
            {
                name = obsId
                description = "Observation ID given by ObserveConfigArg structure as stated in [TMT Software Detailed Design (TMT.SFT.TEC.15.002.REL01)](https://docushare.tmt.org/docushare/dsweb/Get/Document-49912/TMTSoftwareDesign-CSWPD_REL01.pdf)."
                type = string
            }
            {
                name = exposureNumber
                description = """
The exposure # within the observation. This attribute is used to determine the file name written to the disk because there can be multiple exposures in one observation. If multiple exposures are to be taken in one observation, the instrument sequencer will call START_EXPOSURE commands several times with a different exposure #.
"""
                type = integer
                minimum = 0
            }
            {
                name = rampIntegrationTime
                description = "Integration time for one ramp. The specified value will be rounded down to the nearest valid integration time so that it will a multiple of frame readout time."
                type = float
                minimum = 0
                units = ms
            }
            {
                name = ramps
                description = "Number of ramps in one exposure."
                type = integer
                minimum = 1
                default = 1
            }
            {
                name = subregion
                description = """
Subregion definition. First index specifies detector number (0 => #1, 1 => #2, 2 => #3, 3 => #4), the second index specifies either left-bottom-most point or right-top-most point (0 => left-bottom-most, 1 => right-top-most) and the third index specifies x or y (0 => x, 1 => y). The coordinate is 0-based including reference pixel.

The diagram below shows the definition of index of this array attribute.

![Subregion definition](https://raw.githubusercontent.com/chrisaj5/IRIS-Model-Files/master/imager/detector-assembly/subregion_definition.png)

__TBD__: Check if subregion (or subraster) reading is required. If so, some synchronization scheme among four detectors is required for the case different subregion size is set.
"""
                type = array
                dimensions = [4,2,2]
                items = {
                    type = integer
                    minimum = 0
                    maximum = 4095
                }
                units = pixel
            }
        ]
    }
    {
        name = ABORT_EXPOSURE
        description = """
This command aborts the current exposure.

Command type: submit
"""
    }
    {
        name = LOCK
        description = """
This command locks all 4 detectors so that they cannot start clocking or exposure until UNLOCK command is executed. This command will be used in Warm Stow use case as mentioned in [IRIS Software Design Document (TMT.INS.PDD.14.024.DRF07)](https://docushare.tmt.org/docushare/dsweb/Get/Document-32613/160210_IRIS_SDD_DRF07.docx).

__TBD__: Actual action to be taken is TBD.

Command type: submit
"""
    }
    {
        name = UNLOCK
        description = """
This command unlocks all 4 detectors so that they can start exposures. This command will be used in Activate and Warm Activate use cases as mentioned in [IRIS Software Design Document (TMT.INS.PDD.14.024.DRF07)](https://docushare.tmt.org/docushare/dsweb/Get/Document-32613/160210_IRIS_SDD_DRF07.docx).

Command type: submit
"""
    }
    {
        name = DATUM
        description = """
This command turns on power of all 4 detectors if they are not on, then applies the system configuration (e.g. gain, number of channels) to the detector controllers. Timing code may be downloaded to DSP in the detector controllers if necessary. This command can be invoked only when there is no on-going exposure.

Command type: submit
"""
    }
    {
        name = PARK
        description = """
This command cancels all on-going exposures and turns off power of all 4 detectors.

Command type: submit
"""
    }
]
