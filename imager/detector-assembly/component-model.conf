subsystem = IRIS
component = imager-detector-assembly
modelVersion = "1.0"

wbsId = tmt.ins.inst.iris.imager.sw

title = "IRIS Imager Detector Assembly"
prefix = iris.imager.detector
componentType = Assembly

description = """
The Imager Detector Assembly is responsible for configuring and executing individual exposures via the Sidecar or ARC HCD. It will also track status of exposures and report, and provide for aborting exposures.

This assembly is very similar to the IFS Detector Assembly, and may in fact use identical code, if the same HCD is used. It is likely that the Imager will use four detectors, in which case this assembly will additionally be responsible for coordination.

On-chip guiding is coordinated by odgw-assembly separately.

This assembly will not perform any data reduction or sampling arithmetic, which will be done by a separate process in DRS. Instead, readouts are continuously taken during a ramp and all readouts are saved to readout disk (DSK-DRS). Instead of this assembly, underlying HCDs (Sidecar or ARC HCDs) would save the readouts to the disk so that this assembly does not have to unnecessarily communicate with the HCDs to continuously obtain readouts. This assembly sends an event when a new readout is saved to the disk so that DRS will be able to start processing immediately.

__TBD__: Assuming DSK-DRS provides a flat directory structure for each observation (= there is a directory for each observation) via NFS, file name of readout will be readout_img_( _obsId_ )_( _detector #_ )_( _exposure #_ )_( _ramp #_ )_( _readout #_ ).dat, where

* _obsId_ is a string given by ESW. ( __TODO__: Check if obsId will not include underscore or any character which is not allowed or undesired for file names.)
* _detector #_ is one digit integer between 1 and 4.
* _exposure #_ indicates what number of exposure within the observation. This is __TBD__ digits integer starting from 0. The first exposure is 0. (What is the maximum number of exposures in one observation?)
* _ramp #_ indicates what number of ramp within the exposure. This is __TBD__ digits integer starting from 0. The first ramp is 0. (What is the maximum number of ramps in one exposure?)
* _read #_ indicates what number of read within the ramp. This is __TBD__ digits integer starting from 0. The first read is 0. (What is the maximum number of reads in one ramp?)

__DISCUSSION__: File format of readouts should be determined. Because DRS will obtains telemetries directly from other subsystems, only minimal auxiliary information would be added to the file: height, width, timestamp, detector #, exposure #, ramp #, readout #. What else?

The list below is the definition of terms related to the interface to this detector assembly.

* pixel readtime       : Time to select and read one pixel
* number of channels   : Number of channels. Each channel can read one pixel at a time.â€¨ In case of HAWAII-4RG, this can be 1, 4, 16, 32, 64 (TBC).
* reset                : Action to reset all pixels to reset level in a given sub-region
* read                 : One read samples all pixels in a given sub-region.
* frame time           : Time to read all pixels in a given sub-region. (frame time) = (number of pixels in a given sub-region) x (pixel readtime) / (number of channels)
* readout              : An 2D array image generated by each read. All readouts will be saved to DSK-DRS.
* immediate reduction  : Image processing made for each readout.
* ramp                 : A sequence of one or more resets followed by one or more reads.
* exposure             : A sequence of one or more ramps.

![Diagram of detector sampling](https://raw.githubusercontent.com/chrisaj5/IRIS-Model-Files/master/imager/detector-assembly/readout_to_disk.png)

The diagram below shows the naming convention of 4 detectors. Top left detector is #1, top right one is #2, bottom left one is #3 and bottom right one is #4 looking toward the direction of science beam. Some configurations are defined per detector as an array of 4 elements, and the first element (index is 0) corresponds to #1.

![Diagram of detector sampling](https://raw.githubusercontent.com/chrisaj5/IRIS-Model-Files/master/imager/detector-assembly/naming_convention_and_coordinate_of_detector.png)
"""
