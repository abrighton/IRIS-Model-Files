subsystem = IRIS
component = imager.odgw

description = "Imager Detector Assembly Commands."

receive = [
    {
        name = select
        description = """Configure the ODGW types

The select command configures the full set of ODGW types. When ON the window in question is participating in the AO solution and sending exposure data (when the exposure mode is CONTINUOUS) to the NRTC. When set to SATURATION the window is only being used to protect against saturation, and no data are sent to the NRTC. When OFF the window is not active in the AO solution, nor is it being used to guard against saturation.
"""
        requiredArgs = [type]
        args = [
            {
                name = type
                description = """
<ul>
<li> <b>ON</b>: ODGW active and sending data to NRTC
<li> <b>SATURATION</b>: ODGW active but not sending data to NRTC
<li> <b>OFF</b>: ODGW inactive
</ul>
"""
                type = array
                dimensions: [4]
                items = {
                    enum = [ON, SATURATION, OFF]
                }
            }
        ]
    }
    {
        name = exposure
        description = """Set the imager ODGW exposure modes

This command will perform the following actions depending on the selected mode for each of the four ODGWs: CONTINUOUS (continuously take exposures as triggered by NFIRAOS trigger signal and simultaneously step through the guide and acquisition table), STOP (stop exposure), or NOOP (leave exposure mode unchanged).
"""
        requiredArgs = [mode]
        args = [
            {
                name = mode
                description = """
<ul>
<li> <b>CONTINUOUS</b>: continuously take exposures as instructed by NFIRAOS using the fast connection.
<li> <b>STOP</b>: Stop continous exposure.
<li> <b>NOOP</b>: Leave ODGW mode unchanged.
</ul>
"""
                type = array
                dimensions: [4]
                items = {
                    enum = [CONTINUOUS, STOP, NOOP]
                }
            }
            {
                name = rois
                description = "Specify Regions of interest (X,Y, box width in FCRS<sub>IRIS-ROT</sub>), one for each ODGW"
                type = array
                units = mm
                dimensions: [4]
                items = {
                      type = array
                      dimensions: [3]
                      items = {
                          type = double
                      }
                }
            }
        ]
    }

    {
        name = cal_config
        description = """Specify names of calibration files required to process exposures taken with each ODGW.

<em>
Discussion: Unlike the OIWFS, which will need to maintain its own calibration images (flats, darks etc.), the ODGWs can simply use the calibration images from the imager (cutting out the matching ROIs).
</em>

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>

"""
        args = [
            {
                name = flats
                description = "Flatfield filenames for each ODGW"
                type = array
                dimensions: [4]
                items = {
                      type = string
                }
            }
            {
                name = darks
                description = "Dark filenames for each ODGW"
                type = array
                dimensions: [4]
                items = {
                      type = string
                }
            }
        ]
    }

    {
        name = init_acquisition_table
        description = """Set the current ODGW guide/acquisition tables.

Each guide/acquisition table is supplied as a string, one for each ODGW. If the active flag is set to OFF no table will be used.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>

"""
        args = [
            {
                name = active
                description = "Indicate whether each table is in use or not"
                type = array
                dimensions: [4]
                items = {
                      type = boolean
                }
            }
            {
                name = table
                description = "Table for each detector, encoded as strings"
                type = array
                dimensions: [4]
                items = {
                      type = string
                }
            }

        ]
    }

    {
        name = table_jump
        description = """Jump to the specified rows of each ODGW guide/acquisition table

The command fails if the detectors are not in CONTINUOUS exposure mode.

*Discrete Command.*

Precondition:
<ul>
<li> state.cmd != UNINITIALIZED
</ul>
Execution:
<ul>
<li> state.cmd = BUSY
</ul>
At Completion:
<ul>
<li> state.cmd = READY | CONTINUOUS
</ul>

"""
        args = [
            {
                name = row
                description = "Row to jump to in each table. If -1, continue at current row"
                type = array
                dimensions: [4]
                items = {
                      type = integer
                }
            }

        ]
    }

{
    name = offset
    description = """Provide static x,y ODGW positional offsets w.r.t. TCS demands in FCRS<sub>IRIS-ROT</sub> coordinates.

Any static offsets specified by the offset command are added to the continually varying positions from the TCS when the exposure command has set a given ODGW mode to CONTINUOUS or SATURATION (e.g., to account for guide star catalog position errors).

The offsetFlag array indicates which ODGWs are to be offset by this command.

<em>
Discussion: This command is intended for debugging or calibration.
</em>

*Discrete Command.*

"""
    requiredArgs = [offsetFlag, xyOffset]
    args = [
      {
        name          = xyOffset
        description   = "X,Y offsets for the four ODGWs"
        type          = array
        dimensions: [4,2]
        units         = mm
        items = {
          type        = double
        }
      }
      {
        name          = offsetFlag
        description   = "Flags indicating which ODGWs are to be offset"
        type          = array
        dimensions: [4]
        items = {
          type        = boolean
        }
      }
    ]
  }

  {
    name = filter
    description = """Activate and set parameters of a low-pass filter (e.g., Butterworth, TBD) to TCS demand streams when following.

When an ODGW exposure mode is set to CONTINUOUS or SATURATION a low-pass Butterworth filter is applied to TCS demands when following, parameterized by the order and cutoff frequency attributes.

This command can be sent with only the active attribute set in order to activate/de-activate previously configured filters.

*Discrete Command.*

"""
    requiredArgs = [active]
    args = [
      {
        name = active
        description = "Indicate which ODGWs are to have filters applied"
        type = array
        dimensions: [4]
        items = {
          type = boolean
        }
      }
      {
        name = order
        description = "order of filters for the four ODGWs"
        type = array
        minimum = 1
        dimensions: [4]
        items {
          type = integer
        }
      }
      {
        name = cutoff
        description = "cutoff frequencies of filters for the four ODGWs"
        type = array
        minimum = 0
        units = Hz
        dimensions: [4]
        items {
          type = double
        }
      }
    ]
  }
    
]
